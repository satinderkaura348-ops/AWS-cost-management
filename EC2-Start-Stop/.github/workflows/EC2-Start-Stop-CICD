name: EC2 Start/Stop

on:
  workflow_dispatch:
  push:
    branches:
      - dev
    inputs:
      action:
        description: 'start or stop'
        required: true
        default: 'stop'
      private_ip:
        description: 'EC2 private IP'
        required: true
      tag_key:
        description: 'Tag key'
        required: true
      tag_value:
        description: 'Tag value'
        required: true

jobs:
  ec2_control:
    runs-on: ubuntu-latest
    steps:
    - uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-south-1  

    - name: Start/Stop EC2
      run: |
        INSTANCE_ID=$(aws ec2 describe-instances \
          --filters "Name=private-ip-address,Values=${{ github.event.inputs.private_ip }}" \
                    "Name=tag:${{ github.event.inputs.tag_key }},Values=${{ github.event.inputs.tag_value }}" \
          --query "Reservations[*].Instances[*].InstanceId" --output text)

        [ -z "$INSTANCE_ID" ] && { echo "No instance found"; exit 1; }

        if [ "${{ github.event.inputs.action }}" = "start" ]; then
          aws ec2 start-instances --instance-ids "$INSTANCE_ID"
        elif [ "${{ github.event.inputs.action }}" = "stop" ]; then
          aws ec2 stop-instances --instance-ids "$INSTANCE_ID"
        else
          echo "Invalid action"; exit 1
        fi
